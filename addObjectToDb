#!/bin/rc

rfork

. /bin/fedi9/rclib

objectid=$1
shift
if (~ $objectid ''){
	echo Missing object id >[1=2]
	exit 'no object id'
}
if (! ~ `{ndb/query -f $objectsdb id $objectid} ''){
	echo $objectid already in database >[1=2]
	exit 'already added'
}



cachepath=objects/^`{echo $objectid | sed -e 's#(http[s]?://)##'}
mkdir -p $fedi9lib/`{basename -d $cachepath}

fedi9/jsonfs 
cat > /mnt/json/ctl

if (! ~ $objectid `{getStringKey id}){
	echo Object id does not match id >[1=2]
	exit 'bad object id'
}
filename=$fedi9lib^/^$cachepath

objtype=`{getStringKey type}
switch($objtype){
case Note
	attributedTo=`{getStringKey attributedTo}
	if (~ `"{ndb/query -f $actorsdb id $attributedTo} ''){
		echo New actor
		fedi9/get $"attributedTo | fedi9/personrecord >> $actorsdb
	}
	if not {
		echo Attributed to $"attributedTo
	}
	objUrl=`{getStringKey url}
	if (test -e /mnt/json/values/inReplyTo/type){
		switch(`{cat /mnt/json/values/inReplyTo/jsontype}){
		case string
			inReplyTo=`{cat /mnt/json/values/inReplyTo/value}
		case null
			inReplyTo=null
		case *
			echo 'Could not handle inReplyTo type' >[1=2]
			exit 'unhandled inReplyTo'

		}
	}
	if not {
		inReplyTo=null
	}
	publishedTime=`{getStringKey published}
	cp /mnt/json/raw $"filename
	chmod 0644 $"filename

	cat >> $objectsdb <<EOR
id=$objectid cachepath=$cachepath
	attributedTo=$attributedTo
	inReplyTo=$inReplyTo
	url=$objUrl
	publishedTime=$publishedTime
	type=Note
EOR
case Question
	attributedTo=`{getStringKey attributedTo}
	if (~ `"{ndb/query -f $actorsdb id $attributedTo} ''){
		echo New actor
		fedi9/get $"attributedTo | fedi9/personrecord >> $actorsdb
	}
	if not {
		echo Attributed to $"attributedTo
	}
	objUrl=`{getStringKey url}
	if (test -e /mnt/json/values/inReplyTo/type){
		switch(`{cat /mnt/json/values/inReplyTo/jsontype}){
		case string
			inReplyTo=`{cat /mnt/json/values/inReplyTo/value}
		case null
			inReplyTo=null
		case *
			echo 'Could not handle inReplyTo type' >[1=2]
			exit 'unhandled inReplyTo'

		}
	}
	if not {
		inReplyTo=null
	}
	publishedTime=`{getStringKey published}
	endTime=`{getStringKey endTime}
	cp /mnt/json/raw $"filename
	chmod 0644 $"filename

	cat >> $objectsdb <<EOR
id=$objectid cachepath=$cachepath
	attributedTo=$attributedTo
	inReplyTo=$inReplyTo
	url=$objUrl
	publishedTime=$publishedTime
	endTime=$endTime
	type=Question
EOR

case *
	echo Unhandled object type $"objtype >[1=2]
	exit 'unknown object type'
}
exit ''
