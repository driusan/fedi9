#!/bin/rc
rfork

. /bin/fedi9/rclib

cd $home/lib/fedi9/inbox/validated

exiterror=()
fn mvToProcessed {
	base=`{basename $* .body}
	mkdir -p ../processed
	mv $base.^(headers body) ../processed/
}

mkdir -p $home/lib/fedi9/objects
if (! test -e $home/lib/fedi9/objects.db) {
	touch $home/lib/fedi9/objects.db
}
# Use ls instead of the *.body pattern so that
# the empty case gets handled correctly
files=`{ls *.body >[2]/dev/null}
for (file in $files){
	echo File $file
	fedi9/spamcheck $"file

	actor=`{cat $file | fedi9/extractkey actor}
	actorobj=`{ndb/query -f $"actorsdb id $"actor}
	activityType=`{cat $file | fedi9/extractkey type}
	if (~ $"actorobj '') {
		echo New actor $actor in $"actorsdb
		fedi9/get $"actor | fedi9/personrecord >> $actorsdb
	}

	activityType=`{cat $file | fedi9/extractkey type}

	switch ($activityType){
	case 'Create'
		echo 'Create'
		obj=`{fedi9/extractkey object < $file}
		objid=`{echo $"obj | fedi9/extractkey id}
		echo $"obj | fedi9/addObjectToDb $objid
		addStatus=$status
		if (~ $"addStatus ''){
			mvToProcessed $file
		}
		if not {
			echo Could not add object $objid to database: $"addStatus >[1=2]
		}
	case Update
		echo Update
		cachepath=`{ndb/query -f $objectsdb id $"objid cachepath}
		if (~ $cachepath '') {
			echo 'Update unknown object'
			mvToProcessed $file
		}
		if not {
			echo $"obj >$cachepath
			mvToProcessed $file
		}
	case 'Delete'
		echo 'Delete'
		cachepath=`{ndb/query -f $objectsdb id $"objid cachepath}
		if (~ $cachepath '') {
			echo 'Delete unknown object'
			mvToProcessed $file
		}
		if not {
			objtype=`{echo $"obj | fedi9/extractkey type}
			if(~ $"objtype 'Tombstone'){
				echo $"obj >$cachepath
				mvToProcessed $file
			}
			if not {
				echo '{}' >$cachepath
				mvToProcessed $file
			}
		}
	case 'Follow'
		echo 'Follow'
		reqid=`{cat $file | fedi9/extractkey id}
		cachedreq=`{ndb/query -f $followreqdb id $"reqid id}
		if (~ $"cachedreq '') {
			obj=`{cat $file | fedi9/extractkey object}
			echo 'id='$"reqid ' actor='$"actor 'object='$"obj >> $"followreqdb
			mvToProcessed $file
		}
		if not {
			echo 'Already processed follow req' >[2=1]
			mvToProcessed $file
		}
	case 'Undo'
		echo 'Undo'
		obj=`{cat $file | fedi9/extractkey object}
		
		undotype=`{echo $"obj | fedi9/extractkey type}
		switch($"undotype){
		case 'Follow'
			# subobj=`{echo $"obj | fedi9/extractkey object}
			reqid=`{echo $"obj | fedi9/extractkey id}
			if (test -e $undodb) {
				cachedreq=`{ndb/query -f $undodb id $"reqid id}
			}
			if not {
				cachedreq=''
			}
			if (~ $"cachedreq '') {
				reqid=`{echo $"obj | fedi9/extractkey id}
				actor=`{echo $"obj | fedi9/extractkey actor}
				objectid=`{echo $"obj | fedi9/extractkey actor}
				echo 'id='$reqid ' actor='$"actor' object='$"objectid' type='$"undotype >> $undodb
				mvToProcessed $file
			}
			if not {
				echo 'Already processed Undo' >[2=1]
				mvToProcessed $file
			}
		case *
			echo 'Unhandled Undo of type ' $undotype
			exiterror=($exiterror 'no undotype')
		}
		undoobj=`{echo $"obj | fedi9/extractkey id}
		if (test -e $undodb) {
			cachedreq=`{ndb/query -f $undodb id $"reqid id}
		}
		if not {
			cachedreq=''
		}
	case Accept
		echo 'Accept'
		obj=`{cat $file | fedi9/extractkey object}
		
		accepttype=`{echo $"obj | fedi9/extractkey type}
		switch($"accepttype){
		case Follow
			ndbid=`{ndb/query -f $"actorsdb id $"actor id}
			if (~ $"ndbid '') {
				# We did a fedi9/get for the actor object at the
				# start of this script, this shouldn't happen
				echo Could not find $"actor in $"actorsdb >[1=2]
				exit 'no actor'
			}

			if (test -e $followingdb) {
				dupcheck=`{ndb/query -f $followingdb id $"actor id}
				if (~ $dupcheck '') {
					doInsert=true
				}
				if not {
					# Already in following database
					doInsert=false
				}

			}
			if not {
				# DB didn't exist to query, needs to be created
				doInsert=true
			}

			if (~ $doInsert true) {
				echo id'='$ndbid >> $followingdb
			}
			mvToProcessed $file
		case *
			echo Unhandled Accept type $accepttype >[1=2]
			exiterror=($exiterror 'no accept type')
		}
	case Announce
		echo Announce
		actid=`{cat $file | fedi9/extractkey id}
		publishedTime=`{cat $file|fedi9/extractkey published}
		obj=`{cat $file | jsontype='string' fedi9/extractkey object}
		if (~ $"obj ''){
			echo Could not retrieve announce object >[1=2]
			exiterror=($exiterror 'bad announce object')
		}
		if not{
			exists=false
			if (test -e $announcedb){
				if (! ~ `{ndb/query -f $"announcedb id $"actid id} ''){
					exists=true
				}		
			}

			if (~ $exists false){
				cat >> $announcedb << EOR
id=$actid
	type=Announce
	cachepath=../inbox/processed/$file
	actor=$actor
	object=$obj
	publishedTime=$publishedTime
EOR
			}
			mvToProcessed $file
		}
	case *
		echo Unhandled activity type $activityType >[1=2]
		exiterror=($exiterror 'no activity type')
	}
}
exit $"exiterror
